name: Build and Publish Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

jobs:
  build-and-release:
    name: Build, package and publish
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1

      - name: Build solution (Release)
        shell: pwsh
        run: |
          if (Test-Path SVGMapper.Minimal.sln) {
            msbuild SVGMapper.Minimal.sln /p:Configuration=Release /m
          } else {
            msbuild SVGMapper.Minimal/SVGMapper.Minimal.csproj /p:Configuration=Release /m
          }

      - name: Prepare artifacts directory
        shell: pwsh
        run: |
          $out = "$PWD\artifacts"
          if (Test-Path $out) { Remove-Item $out -Recurse -Force }
          New-Item -ItemType Directory -Path $out | Out-Null
          # Prefer existing release/ folder (packaged output), else copy compiled output
          if (Test-Path "$PWD\release") {
            Copy-Item -Path "$PWD\release\*" -Destination $out -Recurse -Force
          } else {
            # try to find Release build outputs from project
            $candidates = Get-ChildItem -Path $PWD -Recurse -Filter "SVGMapper.Minimal.exe" -ErrorAction SilentlyContinue
            if ($candidates) {
              foreach($c in $candidates){ Copy-Item -Path $c.DirectoryName\* -Destination $out -Recurse -Force }
            } else {
              Write-Output "No compiled EXE found; ensure the project builds or add outputs to /release."
            }
          }

      - name: Create portable ZIP
        shell: pwsh
        run: |
          $zip = "$PWD\artifacts\SVGMapper.Minimal.portable.zip"
          if (Test-Path $zip) { Remove-Item $zip -Force }
          Compress-Archive -Path "$PWD\artifacts\*" -DestinationPath $zip -Force
          Write-Output "ZIP created at: $zip"

      - name: Install WiX toolset
        shell: pwsh
        run: |
          choco install wixtoolset -y --no-progress
          Write-Output "WiX installed"

      - name: Harvest release folder with heat.exe
        shell: pwsh
        run: |
          $ReleaseDir = "$PWD\release"
          $outWxs = "$PWD\artifacts\ReleaseFiles.wxs"
          if (-not (Test-Path $ReleaseDir)) { Write-Output "No release folder found; skipping heat"; exit 0 }
          & heat dir "$ReleaseDir" -ag -sfrag -scom -ke -cg ReleaseFiles -dr INSTALLFOLDER -var var.ReleaseDir -out $outWxs
          Write-Output "Harvested $ReleaseDir -> $outWxs"

      - name: Build MSI with WiX (candle & light)
        shell: pwsh
        run: |
          $ReleaseDir = "$PWD\release"
          if (-not (Test-Path $ReleaseDir)) { Write-Output "No release folder found; skipping MSI build"; exit 0 }
          $art = "$PWD\artifacts"
          $productWxs = "$PWD\installer\Product.wxs"
          $releaseWxs = "$art\ReleaseFiles.wxs"
          $prodWixobj = "$art\Product.wixobj"
          $relWixobj = "$art\ReleaseFiles.wixobj"
          & candle.exe $productWxs $releaseWxs -dReleaseDir="$ReleaseDir" -out $prodWixobj
          & light.exe -sval -ext WixUIExtension -out "$art\SVGMapper.Installer.msi" $prodWixobj $relWixobj
          Write-Output "MSI created at: $art\SVGMapper.Installer.msi"

      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          release_name: ${{ github.ref_name }}
          body_path: CHANGELOG.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload portable ZIP as release asset
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: artifacts/SVGMapper.Minimal.portable.zip
          asset_name: SVGMapper.Minimal.portable.zip
          asset_content_type: application/zip

      # Optional: attach existing release binaries from repo (if present)
      - name: Upload release folder files (optional)
        if: always()
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: release/SVGMapper.Minimal.zip
          asset_name: SVGMapper.Minimal.zip
          asset_content_type: application/zip

      - name: Upload MSI installer (if created)
        if: always()
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: artifacts/SVGMapper.Installer.msi
          asset_name: SVGMapper.Installer.msi
          asset_content_type: application/octet-stream
