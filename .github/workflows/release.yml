name: Build and Publish Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

jobs:
  build-and-release:
    name: Build, package and publish
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1

      - name: Restore NuGet packages
        shell: pwsh
        run: |
          if (Test-Path SVGMapper.Minimal.sln) {
            nuget restore SVGMapper.Minimal.sln
          } else {
            nuget restore SVGMapper.Minimal/SVGMapper.Minimal.csproj
          }

      - name: Build solution (Release)
        shell: pwsh
        run: |
          if (Test-Path SVGMapper.Minimal.sln) {
            msbuild SVGMapper.Minimal.sln /p:Configuration=Release /m
          } else {
            msbuild SVGMapper.Minimal/SVGMapper.Minimal.csproj /p:Configuration=Release /m
          }

      - name: Prepare artifacts directory
        shell: pwsh
        run: pwsh -NoProfile -NonInteractive -File .github/scripts/prepare_artifacts.ps1

      - name: Create portable ZIP
        shell: pwsh
        run: |
          $zip = "$PWD\artifacts\SVGMapper.Minimal.portable.zip"
          if (Test-Path $zip) { Remove-Item $zip -Force }
          Compress-Archive -Path "$PWD\artifacts\*" -DestinationPath $zip -Force
          Write-Output "ZIP created at: $zip"

      - name: Create MSIX package
        shell: pwsh
        run: |
          Write-Output "Locating MakeAppx.exe..."
          $makeappx = (Get-ChildItem 'C:\Program Files (x86)\Windows Kits\10\bin' -Recurse -Filter MakeAppx.exe -ErrorAction SilentlyContinue | Select-Object -First 1).FullName
          if (-not $makeappx) { Write-Error "MakeAppx.exe not found. Ensure Windows SDK is installed."; exit 1 }
          $staging = "$PWD\artifacts\msix_staging"
          if (Test-Path $staging) { Remove-Item $staging -Recurse -Force }
          New-Item -ItemType Directory -Path $staging -Force | Out-Null
          Copy-Item "$PWD\artifacts\*" $staging -Recurse -Force
          Copy-Item "$PWD\installer\AppxManifest.xml" "$staging\AppxManifest.xml" -Force
          Write-Output "Packing MSIX to artifacts/SVGMapper.msix"
          & $makeappx pack /d $staging /p "$PWD\artifacts\SVGMapper.msix"
          Write-Output "MSIX created at: $PWD\artifacts\SVGMapper.msix"

      - name: Install WiX toolset
        shell: pwsh
        run: |
          choco install wixtoolset -y --no-progress
          Write-Output "WiX installed"

      - name: Build MSI with WiX (candle & light)
        shell: pwsh
        run: pwsh -NoProfile -NonInteractive -File .github/scripts/build_msi.ps1

      - name: Code-sign MSI (optional, requires certificate)
        shell: pwsh
        run: |
          # Requires a code signing certificate (e.g., PFX file) stored as a secret
          # Set CERT_PATH, CERT_PASSWORD in repository secrets
          if ($env:CERT_PATH -and $env:CERT_PASSWORD) {
            signtool sign /f $env:CERT_PATH /p $env:CERT_PASSWORD /t http://timestamp.digicert.com /d "SVGMapper Installer" artifacts/SVGMapper.Installer.msi
            Write-Output "MSI signed successfully"
          } else {
            Write-Output "No certificate provided, skipping code signing"
          }
        env:
          CERT_PATH: ${{ secrets.CERT_PATH }}
          CERT_PASSWORD: ${{ secrets.CERT_PASSWORD }}

      - name: Create GitHub Release and Upload Assets
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          body_path: CHANGELOG.md
          draft: false
          prerelease: false
          files: |
            artifacts/SVGMapper.Minimal.portable.zip
            artifacts/SVGMapper.Installer.msi
            artifacts/SVGMapper.msix
            release/SVGMapper.Minimal.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
